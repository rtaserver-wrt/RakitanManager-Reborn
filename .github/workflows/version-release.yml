name: Sync Version and Create Release

on:
  push:
    paths:
      - 'version'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync_and_release:
    runs-on: ubuntu-latest
    env:
      INDEX_FILE: rakitanmanager/web/index.php
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Read version file
        id: read_version
        run: |
          version=$(grep -E '^version=' version | cut -d'=' -f2- | tr -d '\r\n')
          lastupdate=$(grep -E '^lastupdate=' version | cut -d'=' -f2- | tr -d '\r\n')
          if [ -z "$version" ]; then
            echo "No version found in 'version' file" >&2
            exit 1
          fi
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "LASTUPDATE=$lastupdate" >> $GITHUB_ENV
          echo "Read version: $version, lastupdate: $lastupdate"

      - name: Update `index.php` with version
        id: update_index
        run: |
          file="${INDEX_FILE}"
          version="${VERSION}"
          last="${LASTUPDATE}"
          if [ ! -f "$file" ]; then
            echo "Index file not found: $file" >&2
            exit 1
          fi
          # Replace $currentVersion and $updatelast lines (keeps formatting)
          perl -0777 -pe "s/\$currentVersion\s*=\s*'[^']*';/\$currentVersion = '${version}';/s" -i "$file"
          perl -0777 -pe "s/\$updatelast\s*=\s*'[^']*';/\$updatelast = '${last}';/s" -i "$file"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add "$file"
            git commit -m "Sync: update index.php to version ${version}"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog for version
        id: changelog
        run: |
          version="${VERSION}"
          # Try to extract the changelog section for this version
          awk -v ver="$version" '
            BEGIN{found=0}
            {
              # Match headers like '#', '##', '###' (optionally with [vX.Y.Z] or vX.Y.Z)
              if (match($0, /^#{1,3}\s*\[?v?([0-9]+([._0-9A-Za-z-]*))\]?/ , arr)) {
                hdr = $0
                if (found) { exit }
                if (index(hdr, ver) || index(arr[1], ver)) {
                  found=1; print $0; next
                }
              } else if (found) {
                print $0
              }
            }' CHANGELOG.md > /tmp/changelog.txt || true

          if [ ! -s /tmp/changelog.txt ]; then
            # Fallback: return entire CHANGELOG.md
            cat CHANGELOG.md > /tmp/changelog.txt
          fi

          # Expose as multi-line output for the release body
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          release_name: "RakitanManager v${{ env.VERSION }}"
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
